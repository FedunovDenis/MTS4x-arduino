# MTS4x Arduino Library

Полнофункциональная Arduino-библиотека для высокоточных цифровых датчиков температуры семейства **MTS4**  
(**MTS4 / MTS4Z / MTS4P / MTS4B**, включая модуль **MTS4P+T4**), с поддержкой **ESP8266**, **ESP32** и классических плат Arduino.

- Диапазон измерений (внутренняя модель чипа): примерно **−103…+153 °C**
- Разрешение: **16 бит**, шаг **0.004 °C**
- Максимальная точность: до **±0.1 °C** в «окне высокой точности» (зависит от модели)
- Режимы: single-shot и continuous, настраиваемые MPS и AVG
- Возможности: CRC, TH/TL, Alert_Mode, heater, user-регистры, E²PROM, паразитное питание
- Платформы: ESP8266, ESP32, AVR (Uno/Nano/Mega) и другие Arduino-совместимые платы

Примеры включают:

- Полный Serial-демо: `MTS4x_FullDemo`
- Wi-Fi метеостанцию с максимальной точностью и JSON-API: `MTS4x_MeteoStation`

---

## Оглавление

1. [Особенности](#особенности)  
2. [Поддерживаемые датчики](#поддерживаемые-датчики)  
3. [Поддерживаемые платформы](#поддерживаемые-платформы)  
4. [Установка](#установка)  
5. [Подключение (схемы и таблицы)](#подключение-схемы-и-таблицы)  
6. [Быстрый старт](#быстрый-старт)  
7. [Примеры из библиотеки](#примеры-из-библиотеки)  
8. [Рецепты использования](#рецепты-использования)  
9. [Обзор API класса MTS4X](#обзор-api-класса-mts4x)  
10. [Режим максимальной точности для метеостанции](#режим-максимальной-точности-для-метеостанции)  
11. [Практические рекомендации](#практические-рекомендации)  
12. [Разводка и EMC](#разводка-и-emc)  
13. [Типичные ошибки и диагностика](#типичные-ошибки-и-диагностика)  
14. [Работа с E²PROM](#работа-с-e²prom)  
15. [Пороги и аварийные сигналы](#пороги-и-аварийные-сигналы)  
16. [Паразитное питание](#паразитное-питание)  
17. [Changelog](#changelog)  
18. [License](#license)  
19. [English summary (short)](#english-summary-short)  

---

## Особенности

### Диапазон и разрешение

- Внутренний диапазон измерителя температуры: примерно **−103…+153 °C**
- Формат результата: 16-битный, шаг **0.004 °C/LSB**

### Точность

Зависит от конкретного варианта MTS4:

- **MTS4P**: до ±0.1 °C в диапазоне примерно −25…+25 °C  
- **MTS4Z**: до ±0.1 °C в диапазоне примерно 0…+50 °C  
- **MTS4**: ±0.1 °C в узком диапазоне комнатной температуры (см. даташит)  
- **MTS4B**: типично ±0.5 °C в широком рабочем диапазоне  

Вне «окна высокой точности» погрешность обычно ±0.5…1.0 °C  
(точные значения см. в документации производителя).

Аппаратное усреднение:

- `AVG_1`, `AVG_8`, `AVG_16`, `AVG_32`

Дополнительно можно делать цифровое усреднение в микроконтроллере  
(пример — метеостанция).

### Режимы измерения

- **Single-shot (одиночное измерение)**  
  Чип переходит в ожидание, каждое измерение запускается отдельной командой.  
  Минимальный самонагрев, идеально для метеостанций и автономных устройств.

- **Continuous (непрерывный)**  
  Чип измеряет периодически с заданной частотой `MPS_xHz`.

- **Stop**  
  Измерения остановлены, чип спит.

Режимы задаются через `setMode()` и `setConfig()`.

### CRC и целостность данных

CRC8 используется для:

- температуры: байты `Temp_Lsb/Msb + Crc_temp`;
- области `scratch` (0x03–0x0A + `Crc_Scratch`);
- области `scratch_ext` (0x0C–0x15 + `Crc_Scratch_Ext`).

Высокоуровневые методы:

- `readTemperatureCrc(...)`
- `readTemperatureRawWithCrc(...)`
- `readScratch(...)`
- `readScratchExt(...)`

### Пороги, алармы, heater, EEPROM

- Программируемые пороги `TH / TL` (в °C, пересчёт в raw выполняется библиотекой).
- Режимы `Alert_Mode`:
  - `HIGH_TH_LOW_CLEAR` — авария при превышении TH, сброс ниже TL;
  - `HIGH_TH_LOW_ALARM` — авария при выходе за диапазон TL–TH.
- Статусный регистр `Status`:
  - флаги HIGH/LOW alarm, BUSY, EE_BUSY, HEATER, TL≥TH и др.
- Встроенный heater (подогреватель):
  - защита от конденсата,
  - самотест (поднятие температуры по команде).
- До 10 user-регистров.
- Команды E²PROM:
  - `copy`, `recall`, `write`, `soft reset`.

---

## Поддерживаемые датчики

Семейство **MTS4**:

| Модель | Окно максимальной точности (типично) | Типовая точность внутри окна | Адрес (обычно) |
|--------|--------------------------------------|------------------------------|----------------|
| MTS4   | узкое окно вокруг комнатной зоны    | до ±0.1 °C                   | 0x41           |
| MTS4Z  | от 0 до +50 °C                       | до ±0.1 °C                   | 0x41           |
| MTS4P  | от −25 до +25 °C                     | до ±0.1 °C                   | 0x41           |
| MTS4B  | широкий диапазон                     | до ±0.5 °C                   | 0x41           |

Особенно удобен модуль **MTS4P+T4** — готовая платка датчика для быстрого подключения к ESP8266/ESP32.

---

## Поддерживаемые платформы

- **ESP8266** (NodeMCU, Wemos D1 mini и аналоги)
- **ESP32** (DevKitC, NodeMCU-32S и т. п.)
- **Arduino AVR** (Uno, Nano, Mega, Pro Mini)
- Любая плата с поддержкой `TwoWire` (I²C)

Использование любой I²C-шины:

```cpp
#include <Wire.h>
#include "MTS4x.h"

MTS4X sensor1(0x41, Wire);    // основная шина
// MTS4X sensor2(0x42, Wire1); // при наличии второй шины Wire1
